<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Middleware  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>
    <a title="Middleware  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html"> 0.7.0 Docs</a> (82% documented)</p>
        <p class="header-right"><a href="https://github.com/hummingbird-project/hummingbird"><img src="img/gh.png"/>View on GitHub</a></p>
        <p class="header-right">
          <form role="search" action="search.json">
            <input type="text" placeholder="Search documentation" data-typeahead>
          </form>
        </p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html"> Reference</a>
        <img id="carat" src="img/carat.png" />
        Middleware  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="encoding-and-decoding.html">Encoding and Decoding</a>
              </li>
              <li class="nav-group-task">
                <a href="error-handling.html">Error Handling</a>
              </li>
              <li class="nav-group-task">
                <a href="extending-hummingbird.html">Extending Hummingbird</a>
              </li>
              <li class="nav-group-task">
                <a href="middleware.html">Middleware</a>
              </li>
              <li class="nav-group-task">
                <a href="router.html">Router</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/HBRequest.html">HBRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/HBRequest/ResponsePatch.html">– ResponsePatch</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/HBResponse.html">HBResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/JSONDecoder.html">JSONDecoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/JSONEncoder.html">JSONEncoder</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/HBCacheControl.html">HBCacheControl</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCacheControl/Value.html">– Value</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie.html">HBCookie</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie/SameSite.html">– SameSite</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie/Properties.html">– Properties</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookies.html">HBCookies</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBFileIO.html">HBFileIO</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBFileMiddleware.html">HBFileMiddleware</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormDecoder.html">URLEncodedFormDecoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormDecoder/DateDecodingStrategy.html">– DateDecodingStrategy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormEncoder.html">URLEncodedFormEncoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormEncoder/DateEncodingStrategy.html">– DateEncodingStrategy</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='middleware' class='heading'>Middleware</h1>

<p>Middleware can be used to edit requests before they are forwared to the router, edit the responses returned by the route handlers or even shortcut the router and return their own responses. Middleware is added to the application as follows.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="kt">HBApplication</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="kt">MyMiddlware</span><span class="p">())</span>
</code></pre>
<h2 id='groups' class='heading'>Groups</h2>

<p>Middleware can also be applied to a specific set of routes using groups. Below is a example of applying an authentication middleware <code>BasicAuthenticatorMiddleware</code> to routes that need protected.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="kt">HBApplication</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="nf">put</span><span class="p">(</span><span class="s">"/user"</span><span class="p">,</span> <span class="n">createUser</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="nf">group</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">middleware</span><span class="p">:</span> <span class="kt">BasicAuthenticatorMiddleware</span><span class="p">())</span>
    <span class="o">.</span><span class="nf">post</span><span class="p">(</span><span class="s">"/user"</span><span class="p">,</span> <span class="n">loginUser</span><span class="p">)</span>
</code></pre>

<p>The first route that calls <code>createUser</code> does not have the <code>BasicAuthenticatorMiddleware</code> applied to it. But the route calling <code>loginUser</code> which is inside the group does have the middleware applied.</p>
<h2 id='writing-middleware' class='heading'>Writing Middleware</h2>

<p>All middleware has to conform to the protocol <code>HBMiddleware</code>. This requires one function <code>apply(to:next)</code> to be implemented. At some point in this function unless you want to shortcut the router and return your own response you are required to call <code>next.respond(to: request)</code> and return the result, or a result processed by your middleware. The following is a simple logging middleware that outputs every URI being sent to the server</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">LogRequestsMiddleware</span><span class="p">:</span> <span class="kt">HBMiddleware</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">apply</span><span class="p">(</span><span class="n">to</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">HBRequest</span><span class="p">,</span> <span class="nv">next</span><span class="p">:</span> <span class="kt">HBResponder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">EventLoopFuture</span><span class="o">&lt;</span><span class="kt">HBResponse</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// log request URI</span>
        <span class="n">request</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="nf">log</span><span class="p">(</span><span class="nv">level</span><span class="p">:</span> <span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="kt">String</span><span class="p">(</span><span class="nv">describing</span><span class="p">:</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="c1">// pass request onto next middleware or the router</span>
        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>If you want to process the response after it has been returned by the route handler you will need to use run a function on the <code>EventLoopFuture</code> returned by <code>next.respond</code>. Swift NIO provide documentation <code>EventLoopFuture</code> <a href="https://apple.github.io/swift-nio/docs/current/NIO/Classes/EventLoopFuture.html">here</a>.</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ResponseProcessingMiddleware</span><span class="p">:</span> <span class="kt">HBMiddleware</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">apply</span><span class="p">(</span><span class="n">to</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">HBRequest</span><span class="p">,</span> <span class="nv">next</span><span class="p">:</span> <span class="kt">HBResponder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">EventLoopFuture</span><span class="o">&lt;</span><span class="kt">HBResponse</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
            <span class="c1">// process responses from handler and middleware further down the chain</span>
            <span class="k">return</span> <span class="nf">processResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="n">flatMapError</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
            <span class="c1">// if an error is thrown by handler or middleware further down the </span>
            <span class="c1">// chain process that</span>
            <span class="k">return</span> <span class="nf">processError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id='already-available' class='heading'>Already available</h2>

<p>Hummingbird comes with a number of middleware already implemented.</p>

<ul>
<li><code>HBCORSMiddleware</code>: Sets CORS headers</li>
<li><code>HBLogRequestsMiddleware</code>: Outputs request details to the log</li>
<li><code>HBMetricsMiddleware</code>: Outputs request details to a metrics server</li>
</ul>

<p>HummingbirdFoundation also provides some middleware</p>

<ul>
<li><code><a href="Structs/HBFileMiddleware.html">HBFileMiddleware</a></code>: Serves static files</li>
<li><code>HBDateResponseMiddleware</code>: Sets the date header in the response in an optimal manner.</li>
</ul>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2021 <a class="link" href="https://github.com/adam-fowler" target="_blank" rel="external">Adam Fowler</a>. All rights reserved. (Last updated: 2021-03-14)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.6</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
