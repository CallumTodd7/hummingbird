<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Jobs  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Jobs  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html"> 0.14.2 Docs</a> (72% documented)</p>
        <p class="header-right"><a href="https://github.com/hummingbird-project/hummingbird"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html"> Reference</a>
        <img id="carat" src="img/carat.png" />
        Jobs  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="encoding-and-decoding.html">Encoding and Decoding</a>
              </li>
              <li class="nav-group-task">
                <a href="error-handling.html">Error Handling</a>
              </li>
              <li class="nav-group-task">
                <a href="extending-hummingbird.html">Extending Hummingbird</a>
              </li>
              <li class="nav-group-task">
                <a href="jobs.html">Jobs</a>
              </li>
              <li class="nav-group-task">
                <a href="middleware.html">Middleware</a>
              </li>
              <li class="nav-group-task">
                <a href="persistent-data.html">Persistent Data</a>
              </li>
              <li class="nav-group-task">
                <a href="router.html">Router</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/HBDateCache.html">HBDateCache</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/HBRequest.html">HBRequest</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/HBRequest/ResponsePatch.html">– ResponsePatch</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/HBResponse.html">HBResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/JSONDecoder.html">JSONDecoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/JSONEncoder.html">JSONEncoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Sequence.html">Sequence</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/HBCacheControl.html">HBCacheControl</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCacheControl/Value.html">– Value</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie.html">HBCookie</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie/SameSite.html">– SameSite</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookie/Properties.html">– Properties</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBCookies.html">HBCookies</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBFileIO.html">HBFileIO</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HBFileMiddleware.html">HBFileMiddleware</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormDecoder.html">URLEncodedFormDecoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormDecoder/DateDecodingStrategy.html">– DateDecodingStrategy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormEncoder.html">URLEncodedFormEncoder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/URLEncodedFormEncoder/DateEncodingStrategy.html">– DateEncodingStrategy</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='jobs' class='heading'>Jobs</h1>

<p>HummingbirdJobs allows you to offload work your server would be doing to another server. You can setup jobs to use different drivers for storing job metadata. The module comes with a driver that stores jobs in local memory and uses your current server to process the jobs, but there is also an implementation that comes with the HummingbirdRedis package that stores jobs in a Redis database. </p>
<h2 id='setting-up-jobs' class='heading'>Setting up Jobs</h2>

<p>Before you can start adding or processing jobs you need to add a jobs driver to the <code>HBApplication</code>. The code below adds a redis driver for jobs. To use a Redis driver you will need to setup Redis first.</p>
<pre class="highlight swift"><code>        <span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="kt">HBApplication</span><span class="p">()</span>
        <span class="k">try</span> <span class="n">app</span><span class="o">.</span><span class="nf">addRedis</span><span class="p">(</span>
            <span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span>
                <span class="nv">hostname</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">redisHostname</span><span class="p">,</span>
                <span class="nv">port</span><span class="p">:</span> <span class="mi">6379</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="nf">addJobs</span><span class="p">(</span>
            <span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="nf">redis</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">queueKey</span><span class="p">:</span> <span class="s">"_myJobsQueue"</span><span class="p">)),</span>
            <span class="nv">numWorkers</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">)</span>
</code></pre>

<p>In this example I called <code>addJob</code> with <code>numWorkers</code> set to <code>0</code>. This means I can add jobs but they will not be processed. To get another server to process these jobs, I should run a separate version of the app which connects to the same Redis queue but with the <code>numWorkers</code> set to the number of threads you want to process the jobs on the queue.</p>
<h2 id='creating-a-job' class='heading'>Creating a Job</h2>

<p>First you must define your job. Create an object that inherits from <code>HBJob</code>. This protocol requires you to implement a static variable <code>name</code> and a function <code>func execute(on:logger)</code>. The <code>name</code> variable should be unique to this job definition. It is used in the serialisation of the job. The <code>execute</code> function does the work of the job and returns an <code>EventLoopFuture</code> that should be fulfilled when the job is complete. Below is an example of a job that calls a <code>sendEmail()</code> function.</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">SendEmailJob</span><span class="p">:</span> <span class="kt">HBJob</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="s">"SendEmail"</span>
    <span class="k">let</span> <span class="nv">to</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">subject</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">String</span>

    <span class="c1">/// do the work</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="n">on</span> <span class="nv">eventLoop</span><span class="p">:</span> <span class="kt">EventLoop</span><span class="p">,</span> <span class="nv">logger</span><span class="p">:</span> <span class="kt">Logger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">EventLoopFuture</span><span class="o">&lt;</span><span class="kt">Void</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">sendEmail</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nv">subject</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="nv">message</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Before you use this job you have to register it. </p>
<pre class="highlight swift"><code><span class="kt">SendEmailJob</span><span class="o">.</span><span class="nf">register</span><span class="p">()</span>
</code></pre>

<p>Now you job is ready to create. Jobs can be queued up using the function <code>enqueue</code> on <code>HBJobQueue</code>. You can access the job queue via <code>HBApplication.jobs.queue</code>. There is a helper object attached to <code>HBRequest</code> that reduces this to <code>HBRequest.jobs.enqueue</code>. </p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">job</span> <span class="o">=</span> <span class="kt">SendEmailJob</span><span class="p">(</span>
    <span class="nv">to</span><span class="p">:</span> <span class="s">"joe@email.com"</span><span class="p">,</span>
    <span class="nv">subject</span><span class="p">:</span> <span class="s">"Testing Jobs"</span><span class="p">,</span>
    <span class="nv">message</span><span class="p">:</span> <span class="s">"..."</span>
<span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nv">job</span><span class="p">:</span> <span class="n">job</span><span class="p">)</span>
</code></pre>

<p><code>enqueue</code> returns an <code>EventLoopFuture</code> that will be fulfilled once the job has been added to the queue.</p>
<h2 id='multiple-queues' class='heading'>Multiple Queues</h2>

<p>HummingbirdJobs allows for the creation of multiple job queues. To create a new queue you need a new queue id.</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">HBJobQueueId</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">newQueue</span><span class="p">:</span> <span class="kt">HBJobQueueId</span> <span class="p">{</span> <span class="s">"newQueue"</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Once you have the new queue id you can register your new queue with this id</p>
<pre class="highlight swift"><code><span class="n">app</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="nf">registerQueue</span><span class="p">(</span><span class="o">.</span><span class="n">newQueue</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="o">.</span><span class="nf">redis</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">queueKey</span><span class="p">:</span> <span class="s">"_myNewJobsQueue"</span><span class="p">)))</span>
</code></pre>

<p>Then when adding jobs you add the queue id to the <code>enqueue</code> function</p>
<pre class="highlight swift"><code><span class="n">request</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nv">job</span><span class="p">:</span> <span class="n">job</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="o">.</span><span class="n">newQueue</span><span class="p">)</span>
</code></pre>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2021 <a class="link" href="https://github.com/adam-fowler" target="_blank" rel="external">Adam Fowler</a>. All rights reserved. (Last updated: 2021-10-22)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.1</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
